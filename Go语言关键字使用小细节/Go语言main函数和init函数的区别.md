## Go 中的 init 函数和main函数



main 标识符是随处可见的，每一个 Go 程序都是从一个叫 main 的包中的 main 函数开始的，当 main 函数返回时，程序执行结束。 init 函数也扮演着特殊的角色，接下来我们将描述下 init 函数的属性并介绍下怎么使用它们。



init 函数在包级别被定义，主要用于：



- 初始化那些不能被初始化表达式完成初始化的变量
- 检查或者修复程序的状态
- 注册
- 仅执行一次的计算
- 更多其它场合

除了下面将要讨论到的一些差异外，你还可以在正则函数中放置任何[有效](https://golang.org/ref/spec#FunctionBody)的内容。



#### 包的初始化

要想使用导入的包首先需要初始化它，这是由golang的运行系统完成的，主要包括(顺序很重要)：

1. 初始化导入的包（递归的定义）
2. 在包级别为声明的变量计算并分配初始值
3. 执行包内的 init 函数（下面的空白标识符就是一个例子）

不管包被导入多少次，都只会被初始化一次。

#### 顺序

Go 的包中有很多的文件，如果变量和函数在包的多个文件当中，那么变量的初始化和 init 函数的调用顺序又是什么样的呢？首先，初始化依赖机制会启动（更多 [Go 中的初始化依赖](https://studygolang.com/articles/13158)）当初始化依赖机制完成的时候，就需要决定 `a.go` 和 `z.go` 中的初始化变量谁会被更早的处理，而这要取决于呈现给编译器的文件顺序。如果 `z.go`先被传递到构建系统，那么变量的初始化就会比在 `a.go` 中先一步完成，这也同样适用于 init 函数的触发。Go 语言规范建议我们始终使用相同的顺序传递，即按照词法顺序传递包中的文件名：



为了保证可重复的初始化行为，构建系统鼓励按照词法文件名的顺序将属于同一个包中的多个文件呈现给编译器。

但依赖特定顺序对于不关注可移植性的程序是一种方式（译注：但不建议依赖 init 初始化顺序）。让我们来看一个例子，看看它们是如何一起工作的：



#### 属性

init 函数不需要参数并且也不返回任何值，与 main 类似，标识符 init 没有被声明所以也就不能被引用：



```go
package main

import "fmt"

func init() {
    fmt.Println("init")
}

func main() {
    init()
}
```

在编译时这里会给出一个 “undefined：init” 错误。（ init 函数不能被引用）

正式的来讲 init 标示符不会引入绑定，就像空白标示符('_')表现的一样。

在同一个包或者文件当中可以定义很多的 init 函数：

init 函数在标准库中也被频繁的使用，例如：[*main*](https://github.com/golang/go/blob/2878cf14f3bb4c097771e50a481fec43962d7401/src/math/pow10.go#L33), [*bzip2*](https://github.com/golang/go/blob/2878cf14f3bb4c097771e50a481fec43962d7401/src/compress/bzip2/bzip2.go#L479)还有 [*image*](https://github.com/golang/go/blob/2d573eee8ae532a3720ef4efbff9c8f42b6e8217/src/image/gif/reader.go#L511)包。

init 函数最常见的用法就是为初始化表达式中不能被计算的那部分分配一个值：



总结：

init函数应用比较广泛，并且使用需要小心点。执行一次进行go语言包的导入和初始化工作。

main 函数和 init 函数  
Go里面有两个保留的函数： init 函数（能够应用于所有的 package ）和 main 函数（只能应用于 package main ）。  
这两个函数在定义时不能有任何的参数和返回值。虽然一个 package 里面可以写任意多个 init 函数，但这无论是对  
于可读性还是以后的可维护性来说，我们都强烈建议用户在一个 package 中每个文件只写一个 init 函数。  
Go程序会自动调用 init() 和 main() ，所以你不需要在任何地方调用这两个函数。每个 package 中的 init 函数都是  
可选的，但 package main 就必须包含一个 main 函数。  
程序的初始化和执行都起始于 main 包。如果 main 包还导入了其它的包，那么就会在编译时将它们依次导入。有时一  
个包会被多个包同时导入，那么它只会被导入一次（例如很多包可能都会用到 fmt 包，但它只会被导入一次，因为没  
有必要导入多次）。当一个包被导入时，如果该包还导入了其它的包，那么会先将其它包导入进来，然后再对这些包  
中的包级常量和变量进行初始化，接着执行 init 函数（如果有的话），依次类推。等所有被导入的包都加载完毕  
了，就会开始对 main 包中的包级常量和变量进行初始化，然后执行 main 包中的 init 函数（如果存在的话），最后执  
行 main 函数。
